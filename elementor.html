<div style="padding-top: 25px; border-top: 1px solid silver;">

  <style>
    .ar-container {
      width: 350px;
      height: 250px;
      margin: auto;
      border: 1px solid silver
    }

    @media screen and (max-width:500px) {
      .ar-container {
        width: 70%
      }
    }

    model-viewer {
      width: 100%;
      height: 99%;
      position: relative;
      background-color: #fff;
      overflow-x: hidden
    }

    .only-ar,
    :not(:defined)>* {
      display: none
    }

    #ar-button {
      background-image: url(https://raw.githubusercontent.com/mahdavifar2002/carpet/main/assets/img/view_in_ar_shamdouni.png);
      background-repeat: no-repeat;
      background-size: 20px 20px;
      background-position: 12px 50%;
      background-color: #fff;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      bottom: 5%;
      padding: 0 16px 0 40px;
      font-family: sans, Roboto Regular, Helvetica Neue, sans-serif;
      font-size: 14px;
      color: #358597;
      height: 36px;
      line-height: 36px;
      border-radius: 18px;
      border: 1px solid #dadce0
    }

    #ar-button:active {
      background-color: #e8eaed
    }

    #ar-button:focus {
      outline: 0
    }

    #ar-button:focus-visible {
      outline: #358597 solid 1px
    }

    model-viewer[ar-status=object-placed]>.only-ar,
    model-viewer[ar-status=session-started]>.only-ar {
      display: block
    }

    .ar-gallary {
      /* margin-top: 60vh; */
    }

    .camera {
      pointer-events: none;
    }

    .shutter {
      height: 72px;
      width: 72px;
      border-radius: 50%;
      border: 5px solid #f8f9fa;
      /* background-color: #8888; */
    }

    .ar-owl-carousel {
      z-index: -1;
    }

    .item-center {
      height: 72px;
      width: 72px;
      border-radius: 50%;
      /* background-color: #4DC7A0; */
      background-size: cover;
      background-position: center center;
      background-clip: padding-box;
      border: 4px solid transparent;
      /* box-shadow: inset 0 0 0 4px #888; */
    }

    .item-content {
      color: white;
      padding: 20px;
    }
  </style>

  <link href="https://cdn.jsdelivr.net/gh/mahdavifar2002/carpet@main/assets/css/bootstrap.min.v0.1.css"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/owl.carousel@2.3.4/dist/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/owl.carousel@2.3.4/dist/assets/owl.theme.default.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/owl.carousel@2.3.4/dist/owl.carousel.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <h4>تکنولوژی واقعیت افزوده (پرو مجازی فرش)</h4>

  <div class="ar-container">
    <script type="module">
      import { ModelViewerElement } from 'https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js';
    </script>

    <model-viewer id="carpet" camera-controls touch-action="pan-y"
      src="https://raw.githubusercontent.com/mahdavifar2002/carpet/main/assets/glb/plane-6m.glb" ar ar-scale="fixed"
      ar-modes="webxr scene-viewer quick-look" camera-orbit="-22.5deg 60deg 70%" camera-target="0m -0.5m 0m"
      alt="A 3D model of a carpet">

      <button slot="ar-button" id="ar-button">
        در خانه‌ی خود ببینید
      </button>

      <div class="only-ar">
        <div id="footer-wrapper">
          <div style="height: 600px;">
            <main id="dom-overlay-main">
              <div class="pos-f-t">
                <div class="collapse show" id="navbarToggleExternalContent">
                  <div class="p-4" style="background-color: #6c757d88;">

                    <div dir="ltr">
                      <button class="btn btn-close" onclick="document.getElementById('ar-exit').click()"></button>
                    </div>

                    <h3 class="text-light" id="ar-title">پرو مجازی فرش</h3>

                    <div id="sizes-form">
                      <label class="text-light">ابعاد: <b id="size-report"></b></label>
                      <div id="sizes"></div>
                    </div>

                    <div id="colors-form">
                      <label class="text-light">رنگ: <b id="color-report"></b></label>
                      <div id="colors"></div>
                    </div>

                  </div>
                </div>

                <div class="bg-dark" style="border: 3px solid black;">
                </div>
              </div>
              <div dir="ltr" class="container" style="margin-left: 50px;">
                <div id="half-circle"
                  style="background-color: #6c757d88; width: 60px; height: 30px; border-bottom-left-radius: 34px; border-bottom-right-radius: 34px; border: 4px solid black; border-top: 0; position: absolute;"
                  class="navbar-toggler" type="button" data-bs-toggle="collapse"
                  data-bs-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent"
                  aria-expanded="true" aria-label="Toggle navigation">
                  <i id="arrow" style="color: black; font-size: 30px; margin-top: -3px; position: absolute;"
                    class="bi bi-arrow-up-short"></i>
                </div>
              </div>
            </main>
          </div>
        </div>

        <div dir="ltr" id="dom-overlay-footer" class="ar-gallary">
          <div id="camera-area" class="camera position-absolute w-100" draggable="false">
            <div class="shutter mx-auto shadow-lg"></div>
          </div>
          <div id="ar-owl" class="ar-owl-carousel owl-carousel position-absolute"></div>
        </div>

      </div>

      <button id="ar-exit" slot="exit-webxr-ar-button" style="display: none;"><i class="bi bi-x-lg"></i></button>

    </model-viewer>

    <script type="module">

      // script to toggle the collapsible

      var myCollapsible = document.getElementById('navbarToggleExternalContent');

      myCollapsible.addEventListener('hide.bs.collapse', function () {
        var arrow = document.getElementById('arrow');
        arrow.classList.remove('bi-arrow-up-short');
        arrow.classList.add('bi-arrow-down-short');
      });

      myCollapsible.addEventListener('show.bs.collapse', function () {
        var arrow = document.getElementById('arrow');
        arrow.classList.remove('bi-arrow-down-short');
        arrow.classList.add('bi-arrow-up-short');
      });

      // script to load colors variants

      const modelViewer = document.querySelector("model-viewer#carpet");

      const createAndApplyTexture = async (textureSrc) => {
        try {
          const channel = 'baseColorTexture';
          const material = modelViewer.model.materials[0];
          const texture = await modelViewer.createTexture(textureSrc);
          if (channel.includes('base') || channel.includes('metallic')) {
            material.pbrMetallicRoughness[channel].setTexture(texture);
          } else {
            material[channel].setTexture(texture);
          }
        }
        catch (e) {
          console.log(e);
        }
      };

      // script to fix the roughness factor for carpet

      modelViewer.addEventListener("load", () => {
        var material = modelViewer.model.materials[0];
        material.pbrMetallicRoughness.setRoughnessFactor(1);
      });

      // script to load sizes

      const switchSrc = (newSrc) => {
        modelViewer.src = newSrc;
      };

      const dimDict = {
        "۶ متری": [3, 1, 2],
        "۹ متری": [3.5, 1, 2.5],
        "۱۲ متری": [4, 1, 3]
      };
      const referenceDim = dimDict["۶ متری"];

      var sizes = document.getElementById('sizes');
      let sizeReport = document.getElementById("size-report");

      for (const size in dimDict) {
        let dim = dimDict[size];

        let button = document.createElement('button');
        button.classList.add("btn", "btn-dark", "ms-1", "mb-1");
        button.textContent = size;

        button.onclick = function () {
          modelViewer.scale = dim[0] / referenceDim[0] + " " + dim[1] / referenceDim[1] + " " + dim[2] / referenceDim[2];

          sizeReport.textContent = button.textContent;
        }

        sizes.appendChild(button);
      }

      // script to load related products

      const products = {};
      products[0] = Object();
      products[0].title = document.querySelector(".product_title").textContent.replace(/\s\s+/g, ' ');
      products[0].url = document.URL;
      products[0].colors = Array();

      // - script to add color for this prodcut

      var colorsDiv = document.getElementById('colors');

      function setProduct(index) {
        colorsDiv.innerHTML = "";

        document.getElementById("ar-title").textContent = products[index].title;
        for (const colorObject of products[index].colors) {
          let button = document.createElement('button');
          button.classList.add("btn", "btn-dark", "ms-1", "mb-1");

          let i = document.createElement('i');
          let span = document.createElement('span');
          i.classList.add("bi", "bi-circle-fill", "h4");

          span.textContent = " " + colorObject.name;
          i.style.color = colorObject.rgb;

          button.appendChild(i);
          button.appendChild(span);

          button.onclick = function () {
            createAndApplyTexture(colorObject.image);

            let colorReport = document.getElementById("color-report");
            colorReport.textContent = span.textContent;
          };

          colorsDiv.appendChild(button);
        }

        colorsDiv.firstElementChild.dispatchEvent(new Event('click'));

        if (products[index].colors[0].name === null)
          document.getElementById("colors-form").style = "display: none;";
        else
          document.getElementById("colors-form").style = "";
      }

      const variationsElement = document.getElementsByClassName("variations")[0];

      for (const item of variationsElement.getElementsByClassName("wd-swatch wd-bg wd-tooltip")) {
        if (!item.hasAttribute("data-title"))
          continue;

        const colorObject = Object();

        colorObject.rgb = item.firstElementChild.style.backgroundColor;
        colorObject.name = item.getAttribute("data-title");

        for (const imageItem of document.getElementsByClassName("product-image-wrap")) {

          colorObject.name = imageItem.firstElementChild.firstElementChild.firstElementChild.alt;

          let text1 = item.getAttribute("data-title").replace(/\s/g, "").replace("\u200C", "");
          let text2 = colorObject.name.replace(/\s/g, "").replace("\u200C", "");

          if (text1 == text2) {
            colorObject.image = imageItem.firstElementChild.firstElementChild.href;

            if (colorObject.image)
              products[0].colors.push(colorObject);
            break;
          }
        }
      }

      // handle special case of no color variations extracted
      if (!products[0].colors || products[0].colors.length === 0) {
        const imageItem = document.getElementsByClassName("product-image-wrap")[0];

        const colorObject = Object();

        colorObject.rgb = "#212529"; // bg-dark
        colorObject.name = imageItem.firstElementChild.firstElementChild.firstElementChild.alt;
        colorObject.image = imageItem.firstElementChild.firstElementChild.firstElementChild.src;
        products[0].colors.push(colorObject);
      }

      // related products
      const relatedProducts = document.getElementsByClassName("related-products")[0];
      if (relatedProducts) {
        for (const [index, item] of Array.from(relatedProducts.getElementsByClassName("product-wrapper")).entries()) {
          products[index + 1] = Object();

          // extract name and link
          const productLink = item.getElementsByClassName("wd-entities-title")[0].firstChild;
          products[index + 1].title = productLink.textContent.replace(/\s\s+/g, ' ');
          products[index + 1].url = productLink.href;
          products[index + 1].colors = Array();

          // extract colors
          const colorsItem = item.getElementsByClassName("wd-swatches-grid")[0];

          if (colorsItem) {
            for (const wpColor of colorsItem.children) {
              const colorObject = Object();

              colorObject.rgb = wpColor.firstElementChild.style.backgroundColor;
              colorObject.name = wpColor.lastElementChild.textContent.replace(/\s\s+/g, ' ');
              colorObject.image = wpColor.getAttribute("data-image-src");

              if (colorObject.image)
                products[index + 1].colors.push(colorObject);
            }
          }

          // handle special case of no color variations extracted
          if (!products[index + 1].colors || products[index + 1].colors.length === 0) {
            const imgItem = item.firstElementChild.firstElementChild.firstElementChild;

            const colorObject = Object();

            colorObject.rgb = "#212529"; // bg-dark
            colorObject.name = null;
            colorObject.image = imgItem.getAttribute("data-lazy-src").replace("-430x573.jpg", ".jpg");
            products[index + 1].colors.push(colorObject);
          }
        }
      }

      for (const index in products) {
        if (products[index].colors && products[index].colors.length != 0) {
          try {
            const div1 = document.createElement('div');
            div1.classList.add("item");
            const div2 = document.createElement('div');
            div2.classList.add("item-center", "mx-auto");
            if (index == 0)
              div1.classList.add("central-item");
            const url = products[index].colors[0].image;
            const url_small = url.substring(0, url.indexOf(".jpg")) + "-225x300.jpg";
            div2.style.backgroundImage = "url(" + url_small + ")";
            div1.appendChild(div2);
            document.getElementById("ar-owl").appendChild(div1);
          }
          catch (e) {
            console.log(index, ":", products[index].colors[0].image);
            console.log(products[index]);
          }
        }
      }

      modelViewer.addEventListener("load", () => {
        setProduct(0);
      });

      // script to run the ar-owl

      document.getElementById('dom-overlay-main').addEventListener('beforexrselect', e => {
        e.preventDefault();
      });
      document.getElementById('dom-overlay-footer').addEventListener('beforexrselect', e => {
        e.preventDefault();
      });

      const owl = $('.ar-owl-carousel');
      owl.owlCarousel({
        center: true,
        responsiveClass: true,
        responsive: {
          0: {
            items: 1
          },
          150: {
            items: 3
          },
          300: {
            items: 5
          }
        }
      });

      function updateCentralItem(oldIndex, newIndex) {
        $('.owl-item').eq(oldIndex).removeClass("centeral-item");
        $('.owl-item').eq(newIndex).addClass("centeral-item");
        $('.item-center').off("click", screenshot);
        $('.item-center').eq(newIndex).click(screenshot);
        setProduct(newIndex);
      }

      $(document).on('click', '.owl-item', function () {
        var oldIndex = $('.ar-owl-carousel').find('.owl-item.center').index();
        var newIndex = $(this).index();

        if (oldIndex != newIndex) {
          $('.owl-stage-outer').trigger('to.owl.carousel', newIndex);
          updateCentralItem(oldIndex, newIndex);
        }
      });

      var dragIndex;

      owl.on('drag.owl.carousel', function (event) {
        dragIndex = $('.ar-owl-carousel').find('.owl-item.center').index();
      });

      owl.on('dragged.owl.carousel', function (event) {
        var dropIndex = event.item.index;

        if (dragIndex != dropIndex) {
          updateCentralItem(dragIndex, dropIndex);
        }
      });

      function screenshot() {
        // alert("screenshot saved.");

        // $('body').html2canvas();
        // var queue = html2canvas.Parse();
        // var canvas = html2canvas.Renderer(queue,{elements:{length:1}});
        // var img = canvas.toDataURL();
        // window.open(img);

        // html2canvas(document.querySelector("body")).then(canvas => {
        //   document.body.appendChild(canvas)
        // });
      }

      $('.item-center').eq(0).click(screenshot);

      // script to fix the footer position
      function fixFooter() {
        // var docHeight = $(window).height();
        // var footerHeight = $('.ar-gallary').height();
        // var footerTop = $('.ar-gallary').position().top + footerHeight;

        // $('.ar-gallary').css('margin-top', -120 + (docHeight - footerTop) + 'px');

        var windows_height = $(window).height();
        var current_height = windows_height - 90;/*change values of 100 how much u need based on your requirement*/
        $("#footer-wrapper").css({ 'min-height': current_height });
      }

      modelViewer.addEventListener('ar-status', (event) => {
        if (event.detail.status == "session-started" || event.detail.status == "object-placed")
          fixFooter();
      });
    </script>
  </div>
</div>